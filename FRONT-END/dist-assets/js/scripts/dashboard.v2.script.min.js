"use strict";
$(document).ready(function () {

// Relação de projectos por sector
  var chartPieSectoresOptions = {
    chart: {
      width: '90%',
      type: 'pie'
    },
    labels: [],
    series: [],
    legend: {
      position: 'bottom'
    },
    responsive: [{
      breakpoint: 480,
      options: {
        chart: {
          width: 300
        },
        legend: {
          position: 'bottom',
          offsetY: 40
        }
      }
    }]
  };
  var chartPieSectores = new ApexCharts(document.querySelector("#projectosPorSector"), chartPieSectoresOptions);
  chartPieSectores.render();
  // ================= Stacked ================

  // Relação de projectos por Financiador
  var barChartFinanciadoroptions = {
    chart: {
      height: 385,
      type: 'bar'
    },
    plotOptions: {
      bar: {
        horizontal: true,
        endingShape: 'rounded'
      }
    },
    dataLabels: {
      enabled: true,
      offsetX: 25,
      style: {
        fontSize: '11px',
        fontFamily: 'Helvetica, Arial, sans-serif',
        colors: ['#333', '#999']
      }
    },
    series: [{
      data: []
    }],
    xaxis: {
      categories: []
    }
  };
  var barChartFinanciador = new ApexCharts(document.querySelector("#projectoPorFinanciador"), barChartFinanciadoroptions);
  barChartFinanciador.render();
  // Chart in Dashboard version 1

  /* Relação de Projectos por Ano */
  var lineChartPrevisaoOptions = {
    chart: {
      height: 350,
      type: 'line',
      dropShadow: {
        enabled: true,
        top: 3,
        left: 3,
        blur: 1,
        opacity: 0.2
      },
      zoom: {
        enabled: false
      },
      toolbar: {
        show: true
      }
    },
    tooltip: {
      enabled: true,
      shared: true,
      followCursor: false,
      intersect: false,
      inverseOrder: false,
      custom: undefined,
      fillSeriesColor: false,
      theme: false
    },
    fill: {
      type: 'gradient',
      gradient: {
        shade: 'dark',
        gradientToColors: ['#FDD835'],
        shadeIntensity: 1,
        type: 'horizontal',
        opacityFrom: 1,
        opacityTo: 1,
        stops: [0, 100, 100, 100]
      }
    },
    markers: {
      size: 4,
      opacity: 0.9,
      colors: ["#FFA41B"],
      strokeColor: "#fff",
      strokeWidth: 2,
      hover: {
        size: 7
      }
    },
    dataLabels: {
      enabled: false
    },
    stroke: {
      curve: 'smooth'
    },
    series: [],
    grid: {
      row: {
        colors: ['#f3f3f3', 'transparent'],
        // takes an array which will be repeated on columns
        opacity: 0.5
      }
    },
    xaxis: {
      categories: []
    },
    markers: {
      size: 6
    },
    dataLabels: {
      enabled: true
    },
  };
  var lineChartPrevisao = new ApexCharts(document.querySelector("#projectosPorAno"), lineChartPrevisaoOptions);
  lineChartPrevisao.render(); // line chart with Data Label
  /* Line chart */

  /* Pesquisa de dados */
  $(document).on("change click",".search",function () {
    let searchType = $(this).attr('value')
    updateDashboard(searchType)
    listarPorProvincia()
  }) /* Fim da pesquisa de dados */

  listarPorProvincia()

  function listarPorProvincia() {
      var sector_id = $("#sector").val();
      var instituicao_id = $("#instituicao").val();
      var provincia_id = $("#provincia_id").val();
      var pesoe = $("#pesoe").val();
      var pesoe_text = "";
      if(pesoe != ""){
        pesoe_text = $("#pesoe").find(":selected").text();
      }else{

      }
      $.ajax({
          url:"./ajax/dashboard/projectoPorProvinciaValor.php",
          method:"POST",
          data:{
              'sector_id':sector_id,
              'instituicao_id':instituicao_id,
              'provincia_id':provincia_id,
              'pesoe': pesoe,
              'pesoe_text': pesoe_text
          },
          dataType:'html',
          success:function(data)
          {
              $("#projectosPorProvincia").html(data);
          },
          error: function (err){
              alert("Error")
              console.log(err)
          }
      })
  }

  updateDashboard()
  function updateDashboard(searchType) {
    let sector = $("#sector").val()
    let sector_option = $('#sector').find(":selected").text();
    let instituicao = $("#instituicao").val()
    let instituicao_option = $('#instituicao').find(":selected").text();
    let fonte_financiamento = '';//$("#fonte_financiamento").val()
    let provincia_id = $("#provincia_id").val();
    let pesoe = $("#pesoe").val();
    let pesoe_text = "";
    if(pesoe != ""){
      pesoe_text = $("#pesoe").find(":selected").text();
    }else{

    }

    $.ajax({
      url: './app/api/reports/dashboardValues.php',
      type: 'GET',
      dataType: "json",
      data: {
        sector: sector,
        instituicao: instituicao,
        fonte_financiamento: fonte_financiamento,
        fase_projecto: searchType,
        provincia_id: provincia_id,
        pesoe: pesoe,
        pesoe_text: pesoe_text
      },
      success: function(response){
        if(sector != "" && instituicao != ""){
          $(".sect_inst").html("<b>"+sector_option+"</b> e instituição <b>"+instituicao_option+"</b>");
        }else if(instituicao != ""){
          $(".sect_inst").html(" e instituição <b>"+instituicao_option+"</b>");
        }else if(sector != ""){
          $(".sect_inst").html("<b>"+sector_option+"</b>");
        }
        // alert(response.projectosExecutados);
        // $(".sect_inst").text(sector_option+" e instituição "+instituicao_option)
        $("#totalProjectos").text(response.valueProjects)
        // $("#projectosFinanciados").text(response.projectosFinanciados)
        // $("#projectosTerminados").text(response.projectosTerminados)
        $("#projectosEmCurso").text(response.projectosExecutados)
        $("#projectosPorFinanciar").text(response.projectosPorFinanciar)
        $("#projectosAtrasados").text(response.projectosNExecutados)

        if(response.sectores.labels.length > 0 && response.instituicoes.labels.length > 0){

          if(sector != ""){
            chartPieSectores.updateOptions({
              labels: response.instituicoes.labels,
              series: response.instituicoes.series,
            });
          }else{
            chartPieSectores.updateOptions({
              labels: response.sectores.labels,
              series: response.sectores.series,
            });
          }
        }else{
          // alert("Não tem")
          chartPieSectores.updateOptions({
            labels: ['Sem Dados'],
            series: [0],
          });
        }

        barChartFinanciador.updateOptions({
          series: [{
            data: response.financiadores.series
          }],
          xaxis: {
            categories: response.financiadores.xaxis
          }
        })

        lineChartPrevisao.updateOptions({
          series: [{
            name: "Projectos",
            data: response.projectosPrevistos.series
          }],
          xaxis: {
            categories: response.projectosPrevistos.xaxis
          }
        })

      },
    });
  }
});